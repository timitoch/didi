<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Words Trainer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

<div class="container">
    

    <div id="upload-container">
        <div class="upload-area" id="upload-area">
            <p>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel (.xlsx) —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</p>
            <small style="color: var(--text-light); margin-top: 10px; display: block;">
                –§–æ—Ä–º–∞—Ç: ID | –ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ | –ü–µ—Ä–µ–≤–æ–¥ | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è 1 (—Ñ–æ—Ä–º—ã –≥–ª–∞–≥–æ–ª–∞) | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è 2 (–ø–∞–¥–µ–∂, –ø—Ä–∏—Å—Ç–∞–≤–∫–∞) | –ü—Ä–∏–º–µ—Ä 1 | –ü—Ä–∏–º–µ—Ä 2 | –ü—Ä–∏–º–µ—Ä 3
            </small>
        </div>
        
        <div class="file-input-container">
            <label for="file-input" class="file-input-button">
                üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
            </label>
            <input type="file" id="file-input" accept=".xlsx,.xls" />
        </div>
        
        <!-- –ë–ª–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
        <div class="sync-container">
            <div class="sync-status" id="sync-status">
                <span id="sync-indicator">üîÑ</span>
                <span id="sync-text">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞</span>
            </div>
            
            <div class="sync-controls">
                <button id="create-sync-btn" class="sync-btn">üîó –°–æ–∑–¥–∞—Ç—å –∫–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</button>
                <button id="join-sync-btn" class="sync-btn">üì≤ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ –∫–æ–¥—É</button>
                <button id="disconnect-sync-btn" class="sync-btn hidden">‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é</button>
            </div>
            
            <div id="sync-code-display" class="sync-code-display hidden">
                <div class="sync-code-header">–í–∞—à –∫–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:</div>
                <div class="sync-code" id="sync-code"></div>
                <small>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º –∫–æ–¥–æ–º —Å –¥—Ä—É–≥–∏–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏</small>
            </div>
            
            <div id="sync-input-container" class="sync-input-container hidden">
                <input type="text" id="sync-code-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏" maxlength="8">
                <button id="connect-sync-btn" class="sync-btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                <button id="cancel-sync-btn" class="sync-btn">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        
        <div class="gender-legend">
            <div class="gender-legend-item">
                <div class="gender-color-box masculine"></div>
                <span>der (–º—É–∂—Å–∫–æ–π)</span>
            </div>
            <div class="gender-legend-item">
                <div class="gender-color-box feminine"></div>
                <span>die (–∂–µ–Ω—Å–∫–∏–π)</span>
            </div>
            <div class="gender-legend-item">
                <div class="gender-color-box neuter"></div>
                <span>das (—Å—Ä–µ–¥–Ω–∏–π)</span>
            </div>
        </div>
    </div>

    <div id="trainer-container" class="hidden">
        <div class="trainer-header">
            <div class="header-left">
                <button id="back-btn" class="back-btn" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–ª–æ–≤–æ">‚Üê</button>
                <button id="reload-file-btn" class="reload-file-btn" title="–û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª">üìÅ</button>
            </div>
            <div class="header-center">
                <h1 class="trainer-title">WordLab</h1>
            </div>
            <div class="header-right">
                <div class="sync-status-small" id="sync-status-small">
                    <span id="sync-indicator-small">üîÑ</span>
                </div>
                <div class="mastered-count" id="mastered-count">
                    –û—Å–≤–æ–µ–Ω–æ: <span id="mastered-number">0</span>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="new-count">0</div>
                <div class="stat-label">–ù–æ–≤—ã—Ö —Å–ª–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="due-count">0</div>
                <div class="stat-label">–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="done-count">0</div>
                <div class="stat-label">–ò–∑—É—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
        </div>

        <div id="card-container" class="card-container"></div>
        
        <div class="rating-buttons" id="rating-container">
            <button class="rating-btn rating-btn-1" data-rating="1">‚ùå –ù–µ –ø–æ–º–Ω—é<br><small>5 –º–∏–Ω—É—Ç</small></button>
            <button class="rating-btn rating-btn-2" data-rating="2">‚ö†Ô∏è –° —Ç—Ä—É–¥–æ–º<br><small>1 –¥–µ–Ω—å</small></button>
            <button class="rating-btn rating-btn-3" data-rating="3">üòê –ß–∞—Å—Ç–∏—á–Ω–æ<br><small>4 –¥–Ω—è</small></button>
            <button class="rating-btn rating-btn-4" data-rating="4">üôÇ –ü–æ—á—Ç–∏<br><small>7 –¥–Ω–µ–π</small></button>
            <button class="rating-btn rating-btn-5" data-rating="5">‚úÖ –ü–æ–º–Ω—é<br><small>12 –¥–Ω–µ–π</small></button>
            <button class="rating-btn rating-btn-6" data-rating="6">‚≠ê –û—Ç–ª–∏—á–Ω–æ<br><small>21 –¥–µ–Ω—å</small></button>
        </div>

        <div id="session-end" class="hidden session-end-message">
            <h2>üéâ –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <p>–í—ã –æ—Ç–ª–∏—á–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª–∏. –ó–∞–π–¥–∏—Ç–µ –ø–æ–∑–∂–µ, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–ª–æ–≤–∞.</p>
        </div>
    </div>
</div>

<script>
// Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const firebaseConfig = {
    apiKey: "AIzaSyDecNXBkdSPE7Vhl3RgbgwOcjLNvPcxsPw",
    authDomain: "wordlab-sync.firebaseapp.com",
    databaseURL: "https://wordlab-sync-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "wordlab-sync",
    storageBucket: "wordlab-sync.firebasestorage.app",
    messagingSenderId: "1095424207075",
    appId: "1:1095424207075:web:0c2e07e78066db3025fdd6"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
const uploadContainer = document.getElementById('upload-container');
const fileInput = document.getElementById('file-input');
const trainerContainer = document.getElementById('trainer-container');
const cardContainer = document.getElementById('card-container');
const ratingContainer = document.getElementById('rating-container');
const sessionEndElement = document.getElementById('session-end');

const backBtn = document.getElementById('back-btn');
const reloadFileBtn = document.getElementById('reload-file-btn');
const newCountEl = document.getElementById('new-count');
const dueCountEl = document.getElementById('due-count');
const doneCountEl = document.getElementById('done-count');
const masteredNumberEl = document.getElementById('mastered-number');
const uploadArea = document.getElementById('upload-area');

// –≠–ª–µ–º–µ–Ω—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
const createSyncBtn = document.getElementById('create-sync-btn');
const joinSyncBtn = document.getElementById('join-sync-btn');
const disconnectSyncBtn = document.getElementById('disconnect-sync-btn');
const syncCodeDisplay = document.getElementById('sync-code-display');
const syncCodeEl = document.getElementById('sync-code');
const syncInputContainer = document.getElementById('sync-input-container');
const syncCodeInput = document.getElementById('sync-code-input');
const connectSyncBtn = document.getElementById('connect-sync-btn');
const cancelSyncBtn = document.getElementById('cancel-sync-btn');
const syncStatus = document.getElementById('sync-status');
const syncText = document.getElementById('sync-text');
const syncIndicator = document.getElementById('sync-indicator');
const syncIndicatorSmall = document.getElementById('sync-indicator-small');
const DAILY_STUDIED_WORDS_KEY = 'daily_studied_words_v3';

// –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
class SyncManager {
    constructor() {
        this.currentSyncCode = null;
        this.isConnected = false;
        this.syncRef = null;
        this.lastSyncTime = 0;
        this.syncDebounceTimer = null;
        
        this.loadSyncSettings();
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        createSyncBtn.addEventListener('click', () => this.createSync());
        joinSyncBtn.addEventListener('click', () => this.showJoinSync());
        disconnectSyncBtn.addEventListener('click', () => this.disconnectSync());
        connectSyncBtn.addEventListener('click', () => this.connectToSync());
        cancelSyncBtn.addEventListener('click', () => this.hideJoinSync());
        
        syncCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.connectToSync();
            }
        });
    }
    
    generateSyncCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }
    
    loadSyncSettings() {
        const savedCode = localStorage.getItem('sync_code');
        if (savedCode) {
            this.currentSyncCode = savedCode;
            this.connectToExistingSync();
        }
    }
    
    async createSync() {
        try {
            const code = this.generateSyncCode();
            this.currentSyncCode = code;
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ Firebase
            await database.ref(`sync_codes/${code}`).set({
                created: firebase.database.ServerValue.TIMESTAMP,
                data: this.getLocalData()
            });
            
            localStorage.setItem('sync_code', code);
            this.setupSyncListener();
            this.showSyncCode(code);
            this.updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞', 'üü¢');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
        }
    }
    
    showJoinSync() {
        syncInputContainer.classList.remove('hidden');
        createSyncBtn.classList.add('hidden');
        joinSyncBtn.classList.add('hidden');
        syncCodeInput.focus();
    }
    
    hideJoinSync() {
        syncInputContainer.classList.add('hidden');
        createSyncBtn.classList.remove('hidden');
        joinSyncBtn.classList.remove('hidden');
        syncCodeInput.value = '';
    }
    
    async connectToSync() {
        const code = syncCodeInput.value.trim().toUpperCase();
        
        if (!code) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
            return;
        }
        
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
            const snapshot = await database.ref(`sync_codes/${code}`).once('value');
            
            if (!snapshot.exists()) {
                alert('–ö–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            this.currentSyncCode = code;
            localStorage.setItem('sync_code', code);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase
            const remoteData = snapshot.val().data;
            if (remoteData) {
                this.mergeRemoteData(remoteData);
            }
            
            this.setupSyncListener();
            this.hideJoinSync();
            this.updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞', 'üü¢');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        }
    }
    
    async connectToExistingSync() {
        if (!this.currentSyncCode) return;
        
        try {
            const snapshot = await database.ref(`sync_codes/${this.currentSyncCode}`).once('value');
            
            if (snapshot.exists()) {
                this.setupSyncListener();
                this.updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞', 'üü¢');
            } else {
                // –ö–æ–¥ –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                this.disconnectSync();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            this.updateSyncStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'üî¥');
        }
    }
    
    setupSyncListener() {
        if (!this.currentSyncCode) return;
        
        this.syncRef = database.ref(`sync_codes/${this.currentSyncCode}/data`);
        
        this.syncRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                const remoteData = snapshot.val();
                const remoteTimestamp = remoteData.lastModified || 0;
                
                // –ò–∑–±–µ–≥–∞–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–∏—Ö –∂–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                if (remoteTimestamp > this.lastSyncTime) {
                    this.mergeRemoteData(remoteData);
                    this.updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'üü¢');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if (fullDeck.length > 0) {
                        updateStatsUI();
                        updateMasteredCount();
                    }
                }
            }
        });
        
        this.isConnected = true;
        disconnectSyncBtn.classList.remove('hidden');
        createSyncBtn.classList.add('hidden');
        joinSyncBtn.classList.add('hidden');
    }
    
    disconnectSync() {
        if (this.syncRef) {
            this.syncRef.off();
            this.syncRef = null;
        }
        
        this.currentSyncCode = null;
        this.isConnected = false;
        localStorage.removeItem('sync_code');
        
        syncCodeDisplay.classList.add('hidden');
        disconnectSyncBtn.classList.add('hidden');
        createSyncBtn.classList.remove('hidden');
        joinSyncBtn.classList.remove('hidden');
        
        this.updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞', 'üîÑ');
    }
    
    showSyncCode(code) {
        syncCodeEl.textContent = code;
        syncCodeDisplay.classList.remove('hidden');
        disconnectSyncBtn.classList.remove('hidden');
        createSyncBtn.classList.add('hidden');
        joinSyncBtn.classList.add('hidden');
    }
    
    updateSyncStatus(text, indicator) {
        syncText.textContent = text;
        syncIndicator.textContent = indicator;
        syncIndicatorSmall.textContent = indicator;
    }
    
    getLocalData() {
        return {
            deck: fullDeck,
            dailyStats: JSON.parse(localStorage.getItem(DAILY_STATS_KEY) || '{}'),
            masteredWords: JSON.parse(localStorage.getItem(MASTERED_KEY) || '{}'),
            lastModified: Date.now()
        };
    }
    
    mergeRemoteData(remoteData) {
        if (remoteData.deck && remoteData.deck.length > 0) {
            fullDeck = this.mergeDeckData(fullDeck, remoteData.deck);
            localStorage.setItem(DECK_KEY, JSON.stringify(fullDeck));
        }
        
        if (remoteData.dailyStats) {
            const localStats = JSON.parse(localStorage.getItem(DAILY_STATS_KEY) || '{}');
            const mergedStats = this.mergeDailyStats(localStats, remoteData.dailyStats);
            localStorage.setItem(DAILY_STATS_KEY, JSON.stringify(mergedStats));
        }
        
        if (remoteData.masteredWords) {
            const localMastered = JSON.parse(localStorage.getItem(MASTERED_KEY) || '{}');
            const mergedMastered = this.mergeMasteredWords(localMastered, remoteData.masteredWords);
            localStorage.setItem(MASTERED_KEY, JSON.stringify(mergedMastered));
        }
        
        this.lastSyncTime = Date.now();
    }
    
    mergeDeckData(local, remote) {
        const merged = new Map();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        local.forEach(card => {
            merged.set(card.id, card);
        });
        
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
        remote.forEach(remoteCard => {
            const localCard = merged.get(remoteCard.id);
            
            if (!localCard) {
                merged.set(remoteCard.id, remoteCard);
            } else {
                // –ë–µ—Ä–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–µ–π –¥–∞—Ç–æ–π —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                const localNext = new Date(localCard.nextReviewDate);
                const remoteNext = new Date(remoteCard.nextReviewDate);
                
                if (remoteNext > localNext) {
                    merged.set(remoteCard.id, remoteCard);
                }
            }
        });
        
        return Array.from(merged.values());
    }
    
    mergeDailyStats(local, remote) {
        const merged = { ...local };
        
        Object.keys(remote).forEach(date => {
            if (!merged[date]) {
                merged[date] = remote[date];
            } else {
                merged[date].done = Math.max(merged[date].done, remote[date].done);
            }
        });
        
        return merged;
    }
    
    mergeMasteredWords(local, remote) {
        const merged = { ...local };
        
        Object.keys(remote).forEach(cardId => {
            if (!merged[cardId]) {
                merged[cardId] = remote[cardId];
            } else {
                // –ë–µ—Ä–µ–º –∑–∞–ø–∏—Å—å —Å –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–µ–π –¥–∞—Ç–æ–π –∏—Å—Ç–µ—á–µ–Ω–∏—è
                const localExpires = new Date(merged[cardId].expires);
                const remoteExpires = new Date(remote[cardId].expires);
                
                if (remoteExpires > localExpires) {
                    merged[cardId] = remote[cardId];
                }
            }
        });
        
        return merged;
    }
    
    async syncToRemote() {
        if (!this.isConnected || !this.currentSyncCode) return;
        
        // –î–µ–±–∞—É–Ω—Å –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        clearTimeout(this.syncDebounceTimer);
        this.syncDebounceTimer = setTimeout(async () => {
            try {
                const data = this.getLocalData();
                await database.ref(`sync_codes/${this.currentSyncCode}/data`).set(data);
                this.lastSyncTime = Date.now();
                this.updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'üü¢');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                this.updateSyncStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'üî¥');
            }
        }, 1000);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
const syncManager = new SyncManager();

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ drag & drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

uploadArea.addEventListener('click', () => {
    fileInput.click();
});

let fullDeck = [];
let sessionQueue = [];
let currentCard = null;
let isCardFlipped = false;
let cardHistory = [];
const DECK_KEY = 'german_words_deck_v3';
const DAILY_STATS_KEY = 'daily_stats_v3';
const MASTERED_KEY = 'mastered_words_v3';

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

ratingContainer.addEventListener('click', handleRating);


backBtn.addEventListener('click', () => {
    if (cardHistory.length === 0) {
        return;
    }
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É –≤ –Ω–∞—á–∞–ª–æ –æ—á–µ—Ä–µ–¥–∏
    if (currentCard) {
        sessionQueue.unshift(currentCard);
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
    const lastCardState = cardHistory.pop();
    currentCard = lastCardState.card;
    const { rating, isNew } = lastCardState;

    // "–û—Ç–∫–∞—Ç—ã–≤–∞–µ–º" —Å—á–µ—Ç—á–∏–∫ "–ò–∑—É—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è", –µ—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ –±—ã–ª–∞ >= 3
    if (rating >= 3) {
        const updatedStats = updateTodayStats(-1);
        window.sessionStats.done = updatedStats.done;
    }
    
    // "–û—Ç–∫–∞—Ç—ã–≤–∞–µ–º" —Å—á–µ—Ç—á–∏–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–ª–æ–≤–∞
    if (isNew) {
        window.sessionStats.new = Math.max(0, window.sessionStats.new + 1);
    } else {
        window.sessionStats.due = Math.max(0, window.sessionStats.due + 1);
    }
    
    // "–û—Ç–∫–∞—Ç—ã–≤–∞–µ–º" —Å—á–µ—Ç—á–∏–∫ "–û—Å–≤–æ–µ–Ω–æ", –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –æ—Ü–µ–Ω–∫–∞ –±—ã–ª–∞ 5 –∏–ª–∏ –≤—ã—à–µ
    if (rating >= 5) {
        let masteredWords = JSON.parse(localStorage.getItem('masteredWords')) || {};
        if (masteredWords[currentCard.id]) {
            delete masteredWords[currentCard.id];
            localStorage.setItem('masteredWords', JSON.stringify(masteredWords));
            updateMasteredCount();
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    updateStatsUI();
    updateBackButton();
    displayCard();
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ —Å–∫—Ä—ã—Ç
    if (!sessionEndElement.classList.contains('hidden')) {
        sessionEndElement.classList.add('hidden');
        cardContainer.classList.remove('hidden');
        ratingContainer.classList.remove('hidden');
    }

    saveProgress();
});

window.addEventListener('load', loadProgress);

function handleFile(file) {
    if (!file) return;
    
    if (!file.name.match(/\.(xlsx|xls)$/i)) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª (.xlsx –∏–ª–∏ .xls)');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            parseAndInitDeck(json);
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.');
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞:', error);
        }
    };
    reader.readAsArrayBuffer(file);
}

function parseAndInitDeck(data) {
    if (!data || data.length < 2) {
        alert('–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö.');
        return;
    }
    
    const newWords = data
        .slice(1)
        .filter(row => row && row[1] && row[2])
        .map(row => ({
            id: row[0] || Math.random().toString(36).substr(2, 9),
            german: row[1] || '',
            translation: row[2] || '',
            additionalInfo1: row[3] || '',
            additionalInfo2: row[4] || '',
            example1: row[5] || '',
            example2: row[6] || '',
            example3: row[7] || '',
            interval: 0,
            easeFactor: 2.5,
            nextReviewDate: new Date().toISOString(),
            gender: detectGender(row[1] || '')
        }));
    
    if (newWords.length === 0) {
        alert('–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.');
        return;
    }
    
    if (fullDeck.length > 0) {
        const existingWords = new Map();
        fullDeck.forEach(word => {
            existingWords.set(word.german, word);
        });
        
        const mergedDeck = [];
        newWords.forEach(newWord => {
            const existingWord = existingWords.get(newWord.german);
            if (existingWord) {
                mergedDeck.push({
                    ...existingWord,
                    german: newWord.german,
                    translation: newWord.translation,
                    additionalInfo1: newWord.additionalInfo1,
                    additionalInfo2: newWord.additionalInfo2,
                    example1: newWord.example1,
                    example2: newWord.example2,
                    example3: newWord.example3,
                    gender: newWord.gender
                });
            } else {
                mergedDeck.push(newWord);
            }
        });
        
        fullDeck = mergedDeck;
        alert(`–§–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω! –î–æ–±–∞–≤–ª–µ–Ω–æ ${newWords.length - existingWords.size} –Ω–æ–≤—ã—Ö —Å–ª–æ–≤.`);
    } else {
        fullDeck = newWords;
    }
    
    saveProgress();
    startSession();
}

function detectGender(germanWord) {
    if (!germanWord) return null;
    
    const word = germanWord.trim().toLowerCase();
    
    if (word.startsWith('der ')) {
        return 'masculine';
    } else if (word.startsWith('die ')) {
        return 'feminine';
    } else if (word.startsWith('das ')) {
        return 'neuter';
    }
    
    if (word.includes('(der)') || word.includes('- der')) {
        return 'masculine';
    } else if (word.includes('(die)') || word.includes('- die')) {
        return 'feminine';
    } else if (word.includes('(das)') || word.includes('- das')) {
        return 'neuter';
    }
    
    return null;
}

function saveProgress() {
    if (fullDeck.length > 0) {
        localStorage.setItem(DECK_KEY, JSON.stringify(fullDeck));
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
        syncManager.syncToRemote();
    }
}

function loadProgress() {
    const savedDeck = localStorage.getItem(DECK_KEY);
    if (savedDeck) {
        fullDeck = JSON.parse(savedDeck);
        fullDeck = fullDeck.map(card => {
            if (!card.gender) {
                card.gender = detectGender(card.german);
            }
            return card;
        });
        if (fullDeck.length > 0) {
            startSession();
        }
    }
}

function getTodayStats() {
    const today = new Date().toDateString();
    const saved = localStorage.getItem(DAILY_STATS_KEY);
    let stats = saved ? JSON.parse(saved) : {};
    
    if (!stats[today]) {
        stats[today] = { done: 0 };
    }
    
    return stats[today];
}

function updateTodayStats(increment = 1) {
    const today = new Date().toDateString();
    const saved = localStorage.getItem(DAILY_STATS_KEY);
    let stats = saved ? JSON.parse(saved) : {};
    
    if (!stats[today]) {
        stats[today] = { done: 0 };
    }
    
    stats[today].done += increment;
    localStorage.setItem(DAILY_STATS_KEY, JSON.stringify(stats));
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    syncManager.syncToRemote();
    
    return stats[today];
}

function startSession() {
    uploadContainer.classList.add('hidden');
    trainerContainer.classList.remove('hidden');
    sessionEndElement.classList.add('hidden');
    
    const now = new Date();
    const dueCards = fullDeck.filter(card => new Date(card.nextReviewDate) <= now);
    const newCards = fullDeck.filter(card => card.interval === 0 && new Date(card.nextReviewDate) <= now);
    
    sessionQueue = dueCards.sort(() => Math.random() - 0.5);
    cardHistory = [];
    
    const todayStats = getTodayStats();
    
    const stats = {
        new: newCards.length,
        due: dueCards.length - newCards.length,
        done: todayStats.done
    };
    
    window.sessionStats = stats;
    updateStatsUI();
    updateMasteredCount();
    
    if (sessionQueue.length > 0) {
        nextCard();
    } else {
        endSession();
    }
}

function updateStatsUI() {
    newCountEl.textContent = window.sessionStats.new;
    dueCountEl.textContent = window.sessionStats.due;
    doneCountEl.textContent = window.sessionStats.done;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è nextCard —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
function nextCard() {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –≥–æ—Ç–æ–≤—ã–µ –∫ –∏–∑—É—á–µ–Ω–∏—é
    if (sessionQueue.length === 0) {
        if (checkSessionCompletion()) {
            return;
        }
        // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
        const readyCards = getCardsReadyForReview();
        if (readyCards.length > 0) {
            sessionQueue = [...readyCards].sort(() => Math.random() - 0.5);
        } else {
            endSession();
            return;
        }
    }
    
    if (currentCard) {
        cardHistory.push(currentCard);
    }
    
    currentCard = sessionQueue.shift();
    isCardFlipped = false;
    updateBackButton();
    displayCard();
}

function goToPreviousCard() {
    if (cardHistory.length === 0) return;
    
    if (currentCard) {
        sessionQueue.unshift(currentCard);
    }
    
    currentCard = cardHistory.pop();
    isCardFlipped = false;
    updateBackButton();
    displayCard();
}

function updateBackButton() {
    backBtn.disabled = cardHistory.length === 0;
}

function displayCard() {
    ratingContainer.classList.remove('hidden');
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –æ–∫—Ä–∞—Å–∫–∏ —Å–ª–æ–≤–∞
    let genderClass = '';
    if (currentCard.gender === 'masculine') {
        genderClass = 'masculine';
    } else if (currentCard.gender === 'feminine') {
        genderClass = 'feminine';
    } else if (currentCard.gender === 'neuter') {
        genderClass = 'neuter';
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    let additionalInfo = '';
    if (currentCard.additionalInfo1) {
        additionalInfo += `<div class="additional-info">${currentCard.additionalInfo1}</div>`;
    }
    if (currentCard.additionalInfo2) {
        additionalInfo += `<div class="additional-info">${currentCard.additionalInfo2}</div>`;
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã
    let examples = '';
    if (currentCard.example1) {
        examples += `<div class="example">${currentCard.example1}</div>`;
    }
    if (currentCard.example2) {
        examples += `<div class="example">${currentCard.example2}</div>`;
    }
    if (currentCard.example3) {
        examples += `<div class="example">${currentCard.example3}</div>`;
    }
    
    cardContainer.innerHTML = `
        <div class="card-inner" id="card-inner">
            <div class="card-face card-front">
                <div class="german-word ${genderClass}">${currentCard.german}</div>
                ${additionalInfo}
                ${examples}
            </div>
            <div class="card-face card-back">
                <div class="translation">${currentCard.translation}</div>
            </div>
        </div>
    `;
    
    document.getElementById('card-inner').addEventListener('click', flipCard);
}

function flipCard() {
    const cardInner = document.getElementById('card-inner');
    
    if (!isCardFlipped) {
        cardInner.classList.add('is-flipped');
        isCardFlipped = true;
    } else {
        cardInner.classList.remove('is-flipped');
        isCardFlipped = false;
    }
}

function handleRating(event) {
    if (!event.target.matches('.rating-btn')) return;

    const rating = parseInt(event.target.dataset.rating, 10);
    const isNew = currentCard.interval === 0;

    if (rating >= 5) {
        updateMasteredWords(currentCard.id, rating);
    }

    updateCardInterval(rating);
    
    if (rating >= 3) {
        const updatedStats = updateTodayStats(1);
        window.sessionStats.done = updatedStats.done;
    }
    
    if (isNew) {
        window.sessionStats.new = Math.max(0, window.sessionStats.new - 1);
    } else {
        window.sessionStats.due = Math.max(0, window.sessionStats.due - 1);
    }

    updateStatsUI();
    updateMasteredCount();
    saveProgress();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π
    const cardState = {
        card: currentCard,
        rating: rating,
        isNew: isNew
    };
    cardHistory.push(cardState);
    
    setTimeout(() => {
        nextCard();
    }, 300);
}

function updateCardInterval(rating) {
    const MIN_EASE = 1.3;
    const ONE_DAY_MS = 24 * 60 * 60 * 1000;
    let { easeFactor, interval, lastReviewDate } = currentCard;
    const now = new Date();

    if (rating < 3) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–∞ 5 –º–∏–Ω—É—Ç –¥–ª—è "–ù–µ –ø–æ–º–Ω—é"
        interval = 5 * 60 * 1000; 
        easeFactor = Math.max(MIN_EASE, easeFactor - 0.2);
    } else {
        if (interval === 0) {
            interval = 0.5; // –ù–∞—á–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞
        } else {
            interval = interval * easeFactor;
        }
        
        if (rating < 5) {
            easeFactor = Math.max(MIN_EASE, easeFactor - 0.1);
        } else {
            easeFactor += 0.1;
        }
    }
    
    currentCard.interval = interval;
    currentCard.easeFactor = easeFactor;
    currentCard.lastReviewDate = now.toISOString();
    
    // –ï—Å–ª–∏ —Ä–µ–π—Ç–∏–Ω–≥ –º–µ–Ω—å—à–µ 3, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –Ω–∞ 5 –º–∏–Ω—É—Ç –≤–ø–µ—Ä–µ–¥.
    // –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç.
    const nextReview = new Date(now.getTime() + (rating < 3 ? 5 * 60 * 1000 : interval * ONE_DAY_MS));
    currentCard.nextReviewDate = nextReview.toISOString();
}

function previewNextReviewDate(card, rating) {
    const MIN_EASE = 1.3;
    let easeFactor = card.easeFactor || 2.5;
    let interval = card.interval || 0;

    if (rating < 3) {
        return new Date(Date.now() + 5 * 60 * 1000);
    }

    if (interval === 0) {
        interval = 1;
    } else if (interval === 1) {
        interval = 4;
    } else {
        interval = Math.round(interval * easeFactor);
    }

    return new Date(Date.now() + interval * 24 * 60 * 60 * 1000);
}

function updateMasteredWords(cardId, rating) {
    let masteredWords = JSON.parse(localStorage.getItem('masteredWords')) || {};
    
    // –ï—Å–ª–∏ —Å–ª–æ–≤–æ –æ—Å–≤–æ–µ–Ω–æ (–æ—Ü–µ–Ω–∫–∞ 5 –∏–ª–∏ –≤—ã—à–µ), –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —Å–ø–∏—Å–æ–∫ –æ—Å–≤–æ–µ–Ω–Ω—ã—Ö
    if (rating >= 5) {
        if (!masteredWords[cardId]) {
            masteredWords[cardId] = true;
        }
    } else {
        // –ï—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ –Ω–∏–∂–µ 5, —É–¥–∞–ª—è–µ–º –∏–∑ –æ—Å–≤–æ–µ–Ω–Ω—ã—Ö
        if (masteredWords[cardId]) {
            delete masteredWords[cardId];
        }
    }

    localStorage.setItem('masteredWords', JSON.stringify(masteredWords));
    updateMasteredCount();
}

function updateMasteredCount() {
    const now = new Date();
    const saved = localStorage.getItem(MASTERED_KEY);
    let mastered = saved ? JSON.parse(saved) : {};
    
    // –£–¥–∞–ª—è–µ–º –∏—Å—Ç–µ–∫—à–∏–µ –∑–∞–ø–∏—Å–∏
    for (const [cardId, data] of Object.entries(mastered)) {
        if (new Date(data.expires) <= now) {
            delete mastered[cardId];
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    localStorage.setItem(MASTERED_KEY, JSON.stringify(mastered));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    const count = Object.keys(mastered).length;
    masteredNumberEl.textContent = count;
}

function endSession() {
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏ –∫–Ω–æ–ø–∫–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–∏–¥–∏–º—ã–º
    cardContainer.classList.add('hidden');
    ratingContainer.classList.add('hidden');
    sessionEndElement.classList.remove('hidden');

    const now = new Date();
    // –ò—â–µ–º –≤—Å–µ —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –≤ –±—É–¥—É—â–µ–º
    const futureCards = fullDeck.filter(card => new Date(card.nextReviewDate) > now);

    if (futureCards.length > 0) {
        // –ù–∞—Ö–æ–¥–∏–º —Å–∞–º–æ–µ –±–ª–∏–∂–∞–π—à–µ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
        futureCards.sort((a, b) => new Date(a.nextReviewDate) - new Date(b.nextReviewDate));
        const nextCard = futureCards[0];
        const nextReviewDate = new Date(nextCard.nextReviewDate);
        
        const diffMinutes = Math.ceil((nextReviewDate - now) / (1000 * 60));

        let timeToNext = '';
        if (diffMinutes < 60) {
            timeToNext = `–ø—Ä–∏–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ ${diffMinutes} –º–∏–Ω.`;
        } else if (diffMinutes < 1440) {
            timeToNext = `–ø—Ä–∏–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ ${Math.round(diffMinutes / 60)} —á.`;
        } else {
            timeToNext = `–ø—Ä–∏–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ ${Math.round(diffMinutes / 1440)} –¥.`;
        }
        
        sessionEndElement.querySelector('p').textContent = `–í—ã –æ—Ç–ª–∏—á–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª–∏! –°–ª–µ–¥—É—é—â–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ ${timeToNext}`;
    } else {
        sessionEndElement.querySelector('p').textContent = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã—É—á–∏–ª–∏ –≤—Å–µ —Å–ª–æ–≤–∞.';
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
function setupAutoSync() {
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
        originalSetItem.call(this, key, value);
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—à–∏ –∫–ª—é—á–∏
        if ([DECK_KEY, DAILY_STATS_KEY, MASTERED_KEY].includes(key)) {
            if (syncManager.isConnected) {
                syncManager.syncToRemote();
            }
        }
    };
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    setInterval(() => {
        if (syncManager.isConnected) {
            syncManager.updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞', 'üü¢');
        }
    }, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
function handleConnectionError() {
    syncManager.updateSyncStatus('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'üî¥');
    
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (syncManager.currentSyncCode && !syncManager.isConnected) {
            syncManager.connectToExistingSync();
        }
    }, 30000);
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–æ–±—ã—Ç–∏–π –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω
window.addEventListener('online', () => {
    if (syncManager.currentSyncCode && !syncManager.isConnected) {
        syncManager.connectToExistingSync();
    }
});

window.addEventListener('offline', () => {
    syncManager.updateSyncStatus('–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º', 'üî¥');
});

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    `;
    
    if (type === 'success') {
        notification.style.backgroundColor = '#10b981';
    } else if (type === 'error') {
        notification.style.backgroundColor = '#ef4444';
    } else {
        notification.style.backgroundColor = '#3b82f6';
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const notificationStyles = document.createElement('style');
notificationStyles.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(notificationStyles);

// –†–∞—Å—à–∏—Ä—è–µ–º SyncManager –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const originalSyncToRemote = syncManager.syncToRemote;
syncManager.syncToRemote = async function() {
    try {
        await originalSyncToRemote.call(this);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
        if (this.lastSyncStatus === 'error') {
            showNotification('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'success');
        }
        this.lastSyncStatus = 'success';
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
        this.updateSyncStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'üî¥');
        this.lastSyncStatus = 'error';
        showNotification('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
    }
};

// –†–∞—Å—à–∏—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
const originalConnectToSync = syncManager.connectToSync;
syncManager.connectToSync = async function() {
    try {
        await originalConnectToSync.call(this);
        showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'success');
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
        throw error;
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
setupAutoSync();

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
    if (syncManager.isConnected) {
        syncManager.syncToRemote();
    }
});

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
function checkSyncStatus() {
    if (syncManager.isConnected && syncManager.currentSyncCode) {
        return {
            connected: true,
            code: syncManager.currentSyncCode,
            lastSync: syncManager.lastSyncTime
        };
    }
    return {
        connected: false,
        code: null,
        lastSync: null
    };
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –∫ –∏–∑—É—á–µ–Ω–∏—é
function getCardsReadyForReview() {
    const now = new Date();
    return fullDeck.filter(card => {
        const nextReviewDate = new Date(card.nextReviewDate);
        return nextReviewDate <= now;
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
function checkSessionCompletion() {
    const readyCards = getCardsReadyForReview();
    
    if (readyCards.length === 0 && sessionQueue.length === 0) {
        endSession();
        return true;
    }
    return false;
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
function debugShowNextReviewTimes() {
    console.log('–í—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞:');
    fullDeck.forEach((card, index) => {
        const nextReview = new Date(card.nextReviewDate);
        const now = new Date();
        const diffMinutes = Math.round((nextReview - now) / (1000 * 60));
        
        console.log(`${index + 1}. ${card.german} - —á–µ—Ä–µ–∑ ${diffMinutes} –º–∏–Ω—É—Ç (${nextReview.toLocaleString()})`);
    });
}

// –î–æ–±–∞–≤–ª—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.debugReviewTimes = debugShowNextReviewTimes;
// –î–æ–±–∞–≤–ª—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.syncStatus = checkSyncStatus;

// –§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
console.log('WordLab —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
console.log('–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: window.syncStatus()');
</script>

</body>
</html>